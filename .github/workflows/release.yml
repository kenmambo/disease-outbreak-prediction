name: ğŸš€ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  PYTHON_VERSION: "3.10"
  UV_VERSION: "latest"

jobs:
  # ğŸ—ï¸ Build artifacts
  build:
    name: ğŸ—ï¸ Build Release Artifacts
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: âš¡ Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: ${{ env.UV_VERSION }}
        enable-cache: true
        
    - name: ğŸ“¦ Build package
      run: |
        uv venv
        uv pip install build
        uv run python -m build
        
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist-${{ matrix.os }}
        path: dist/

  # ğŸ§ª Pre-release testing
  pre-release-test:
    name: ğŸ§ª Pre-release Testing
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: âš¡ Install uv
      uses: astral-sh/setup-uv@v2
      with:
        version: ${{ env.UV_VERSION }}
        enable-cache: true
        
    - name: ğŸ“¥ Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: dist-ubuntu-latest
        path: dist/
        
    - name: ğŸ§ª Test installation from wheel
      run: |
        uv venv test-env
        uv pip install dist/*.whl
        source .venv/bin/activate
        python -c "import disease_outbreak_prediction; print('âœ… Package installation successful')"
        
    - name: ğŸ§ª Run comprehensive tests
      run: |
        uv venv
        uv pip install -e ".[dev]"
        uv run pytest --verbose
        
    - name: ğŸ¤– Test model training
      run: |
        mkdir -p data/{raw,processed} models
        timeout 300 uv run python -m disease_outbreak_prediction.train || true
        
  # ğŸ·ï¸ Create GitHub release
  release:
    name: ğŸ·ï¸ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, pre-release-test]
    permissions:
      contents: write
      
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: ğŸ“ Generate changelog
      id: changelog
      run: |
        # Get the latest tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LATEST_TAG" ]; then
          echo "First release"
          CHANGELOG="ğŸ‰ Initial release of Disease Outbreak Prediction System"
        else
          echo "Generating changelog since $LATEST_TAG"
          CHANGELOG=$(git log --pretty=format:"- %s" $LATEST_TAG..HEAD | head -20)
        fi
        
        # Save changelog to file and output
        echo "$CHANGELOG" > CHANGELOG.md
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ·ï¸ Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || github.event.inputs.version }}
        release_name: Disease Outbreak Prediction ${{ github.ref_name || github.event.inputs.version }}
        body: |
          ## ğŸ¦  Disease Outbreak Prediction System Release
          
          ### ğŸ“‹ What's Changed
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸš€ Quick Start
          ```bash
          # Install the package
          pip install disease-outbreak-prediction
          
          # Or download and install from source
          git clone https://github.com/yourusername/disease-outbreak-prediction.git
          cd disease-outbreak-prediction
          uv venv && uv pip install -e .
          
          # Train models
          uv run python -m disease_outbreak_prediction.train
          
          # Launch dashboard
          uv run streamlit run disease_outbreak_prediction/dashboard/app.py
          ```
          
          ### ğŸ“Š Features in this Release
          - ğŸ§  LSTM Neural Network for time-series forecasting
          - ğŸŒ Random Forest for spatial analysis
          - ğŸ“Š Interactive Streamlit dashboard
          - ğŸ”„ Cross-platform compatibility
          - ğŸ“ˆ Real-time outbreak risk assessment
          
          ### ğŸ’¾ Downloads
          Choose the appropriate package for your platform:
          - **Windows**: `dist-windows-latest.zip`
          - **macOS**: `dist-macos-latest.zip`
          - **Linux**: `dist-ubuntu-latest.zip`
          
          ### ğŸ› Known Issues
          - See [Issues](https://github.com/yourusername/disease-outbreak-prediction/issues) for current known issues
          
          ---
          
          ğŸ™ **Thank you to all contributors who made this release possible!**
        draft: false
        prerelease: false
        
    - name: ğŸ“¤ Upload Release Assets
      run: |
        # Upload each platform's artifacts
        for os in ubuntu-latest windows-latest macos-latest; do
          zip -r dist-$os.zip dist-$os/
          gh release upload ${{ github.ref_name || github.event.inputs.version }} dist-$os.zip
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ“¢ Post-release notifications
  notify:
    name: ğŸ“¢ Post-Release Notifications
    runs-on: ubuntu-latest
    needs: release
    if: always()
    
    steps:
    - name: ğŸ‰ Success notification
      if: needs.release.result == 'success'
      run: |
        echo "ğŸ‰ Release ${{ github.ref_name || github.event.inputs.version }} published successfully!"
        echo "ğŸ“Š Dashboard: Available at release artifacts"
        echo "ğŸ¤– Models: Training pipeline tested and verified"
        
    - name: âŒ Failure notification
      if: needs.release.result == 'failure'
      run: |
        echo "âŒ Release failed. Please check the logs and retry."
        exit 1